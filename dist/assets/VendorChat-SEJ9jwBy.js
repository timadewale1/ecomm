import{u as e,k as s,h as t,f as n,r as a,i as r,R as o,eH as l,l as i,q as d,e7 as c,w as u,c as x,a as m,o as p,d as f,eI as h,eJ as g,eK as b,j as v,F as y,S as j,Q as N,bH as w,eL as k,$ as C,eM as O,eN as R,b as S,ac as I,s as A,_ as T,y as F,T as L}from"./index-CvIXhaMv.js";import{g as P,i as $}from"./index-DV9LhBdq.js";function M(){const{inquiryId:M}=e(),U=s(),q=t(),E=n(),W="offer"===new URLSearchParams(U.search).get("type"),z="offerThread"===new URLSearchParams(U.search).get("type"),_=new URLSearchParams(U.search).get("buyerId"),B=new URLSearchParams(U.search).get("productId"),[D,Y]=a.useState(null),[H,G]=a.useState(null),[K,V]=a.useState(!1),[J,Q]=a.useState(W),[X,Z]=a.useState(null),{inquiry:ee,product:se,customer:te,loading:ne,error:ae}=r((e=>e.chat)),re=W?null==D?void 0:D.buyerId:null==ee?void 0:ee.customerId,oe=r((e=>re?e.vendorChats.profiles[re]:null));o.useEffect((()=>{re&&!oe&&E(l(re))}),[E,re,oe]);const[le,ie]=a.useState(""),[de,ce]=a.useState(!1),[ue,xe]=a.useState(!1),[me,pe]=a.useState(!1),[fe,he]=a.useState(""),[ge,be]=a.useState(""),[ve,ye]=a.useState(!1),[je,Ne]=a.useState(""),[we,ke]=a.useState(!1),[Ce,Oe]=a.useState(!1);a.useEffect((()=>{var e;if(M){if(z){const s=null==(e=i.currentUser)?void 0:e.uid;if(!s||!_||!B)return;const t=d(x(m,"offers"),u("vendorId","==",s),u("buyerId","==",_),u("productId","==",B),c("createdAt","asc")),n=p(t,(async e=>{const s=e.docs.map((e=>({id:e.id,...e.data()})));if(!s.length)return Z("No offers in this thread."),void Q(!1);const t=s[s.length-1];if(Y(t),t.productId&&!H){const e=await F(f(m,"products",t.productId));e.exists()&&G({id:e.id,...e.data()})}s.forEach((e=>{e.vendorRead||I(f(m,"offers",e.id),{vendorRead:!0}).catch((()=>{}))})),Q(!1)}),(e=>{Z("Failed to load thread"),Q(!1)}));return()=>n()}if(W){const e=f(m,"offers",M),s=p(e,(async s=>{if(!s.exists())return Z("Offer not found"),void Q(!1);const t={id:s.id,...s.data()};if(Y(t),t.vendorRead||I(e,{vendorRead:!0}).catch((()=>{})),t.productId){const e=await F(f(m,"products",t.productId));e.exists()&&G({id:e.id,...e.data()})}Q(!1)}),(e=>{Z("Failed to load offer"),Q(!1)}));return()=>s()}return E(h(M)),E(g(M)),()=>E(b())}}),[E,M,W,z,_,B,H]);const Re=a.useMemo((()=>(null==oe?void 0:oe.displayName)||(null==te?void 0:te.username)||re||"Customer"),[null==oe?void 0:oe.displayName,null==te?void 0:te.username,re]),Se=W?X:ae,Ie={pending:{bg:"bg-amber-50",text:"text-amber-800",ring:"ring-amber-200",dot:"bg-amber-500",label:"Pending"},countered:{bg:"bg-sky-50",text:"text-sky-800",ring:"ring-sky-200",dot:"bg-sky-500",label:"Countered"},accepted:{bg:"bg-emerald-50",text:"text-emerald-800",ring:"ring-emerald-200",dot:"bg-emerald-500",label:"Accepted"},declined:{bg:"bg-rose-50",text:"text-rose-800",ring:"ring-rose-200",dot:"bg-rose-500",label:"Declined"},expired:{bg:"bg-slate-50",text:"text-slate-700",ring:"ring-slate-200",dot:"bg-slate-400",label:"Expired"}};if(W?J:ne)return v.jsx(y,{});if(Se)return v.jsx("div",{className:"flex items-center justify-center h-full",children:v.jsx("div",{className:"text-red-500 font-opensans",children:"Error: We’re looking into this"})});const Ae=W&&D&&"pending"===D.status,Te=e=>e instanceof L?e.toDate().toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"",Fe=e=>Number(e||0).toLocaleString("en-NG",{style:"currency",currency:"NGN",maximumFractionDigits:0}),Le=async()=>{if(D)try{await I(f(m,"offers",D.id),{status:"accepted",acceptedAt:A(),vendorRead:!0,buyerRead:!1}),T.success("Offer accepted.")}catch(e){T.error("Could not accept. Try again.")}},Pe=async()=>{if(D)try{await I(f(m,"offers",D.id),{status:"declined",declinedAt:A(),vendorRead:!0,buyerRead:!1}),T.success("Offer declined.")}catch(e){T.error("Could not decline. Try again.")}},$e=async()=>{if(!D)return;if(!["pending","countered"].includes(D.status))return T.error("This offer can no longer be countered.");const e=Math.round(Number(je));if(!Number.isFinite(e)||e<=0)return T.error("Enter a valid counter price.");const s=Number(D.amount||0),t=Number(qe||0);if(!(s+1<=t-1))return T.error("Counter not possible (offer is already near list price).");if(e<=s)return T.error(`Counter must be more than the buyer’s offer (${Fe(s)}).`);if(e>=t)return T.error(`Counter must be less than the list price (${Fe(t)}).`);try{await I(f(m,"offers",D.id),{status:"countered",counterAmount:e,counteredAt:A(),vendorRead:!0,buyerRead:!1}),T.success("Counter sent."),Ne("")}catch(n){T.error("Could not send counter. Try again.")}},Me=W?H:se,Ue=(null==Me?void 0:Me.name)||"Product",qe=(null==Me?void 0:Me.price)||0;return v.jsxs(v.Fragment,{children:[v.jsx(j,{title:W?`Offer from ${Re} – My Thrift`:`Chat with ${Re} – My Thrift`,description:W?`Review and respond to an offer on "${Ue}".`:`Continue your conversation about "${Ue}".`,url:`https://www.shopmythrift.store/vchats/${M}${W?"?type=offer":""}`}),v.jsxs("div",{className:"flex flex-col h-[100dvh] w-full mx-auto bg-white",children:[v.jsxs("div",{className:"sticky top-0 bg-white z-20 border-b px-4 py-3 flex items-center",children:[v.jsx(N,{className:"cursor-pointer mr-4 text-2xl text-gray-700",onClick:()=>q("/vchats")}),v.jsxs("div",{className:"flex-1 flex items-center justify-between",children:[v.jsxs("div",{children:[v.jsx("div",{className:"font-semibold text-lg text-gray-800 font-opensans",children:Ue}),v.jsxs("div",{className:"text-sm text-gray-500 font-opensans",children:["Chat with"," ",(null==oe?void 0:oe.displayName)||(null==te?void 0:te.username)||(null==ee?void 0:ee.customerId)]})]}),v.jsxs("div",{className:"relative",children:[v.jsx(w,{className:"text-2xl text-gray-700 cursor-pointer",onClick:()=>xe((e=>!e))}),ue&&v.jsx("div",{className:"absolute right-0 mt-2 w-44 bg-white rounded-lg shadow-lg border z-30",onMouseLeave:()=>xe(!1),children:(null==ee?void 0:ee.reported)?v.jsxs("button",{className:"flex items-center px-4 py-2 text-sm font-opensans w-full hover:bg-gray-100",onClick:()=>{xe(!1),Oe(!0)},children:[v.jsx(k,{className:"mr-2 text-customOrange"}),"View report status"]}):v.jsxs("button",{className:"flex items-center px-4 py-2 text-sm font-opensans w-full hover:bg-gray-100",onClick:()=>{xe(!1),pe(!0)},children:[v.jsx(k,{className:"mr-2 text-customOrange"}),"Report chat"]})})]})]})]}),Me&&v.jsxs("div",{className:"relative px-4 py-4 flex flex-col items-start",children:[v.jsxs("div",{onClick:()=>{const e=W?null==D?void 0:D.productId:null==ee?void 0:ee.productId;e&&q("/vendor-products",{state:{highlightId:e}})},className:"relative w-64 h-64 rounded-lg overflow-hidden cursor-pointer",children:[v.jsx("img",{src:Me.coverImageUrl,alt:Me.name,className:"w-full h-full object-cover"}),v.jsx("div",{className:"absolute bottom-3 right-3 bg-black bg-opacity-70 text-white text-[11px] px-3 py-1 rounded-full font-opensans shadow-lg",children:"Tap to View Details"})]}),v.jsx("p",{className:"text-xs font-opensans mt-2",children:W?v.jsxs(v.Fragment,{children:[(null==oe?void 0:oe.displayName)||(null==te?void 0:te.username)||(null==ee?void 0:ee.customerId)," ","made an offer for"," ",v.jsx("span",{className:"uppercase text-customOrange font-semibold",children:Ue}),"."]}):v.jsxs(v.Fragment,{children:["One‐way chat —"," ",(null==oe?void 0:oe.displayName)||(null==te?void 0:te.username)||(null==ee?void 0:ee.customerId)," ","asked about"," ",v.jsx("span",{className:"uppercase text-customOrange font-semibold",children:Ue}),". You have one reply; please be clear. Thanks!"]})})]}),v.jsxs("div",{className:"flex-1 overflow-auto p-4 space-y-6",children:[v.jsxs("div",{className:"flex",children:[(null==oe?void 0:oe.photoURL)?v.jsx("img",{src:oe.photoURL,alt:"customer avatar",className:"w-10 h-10 rounded-full object-cover mr-3"}):v.jsx(P,{className:"w-10 h-10 text-gray-400 mr-3"}),v.jsx("div",{children:W?v.jsxs(v.Fragment,{children:[v.jsxs("div",{className:"bg-gray-100 text-gray-800 rounded-lg px-4 py-2 font-opensans max-w-xs",children:[v.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[v.jsx("span",{className:"line-through font-opensans text-gray-500",children:Fe(qe)}),v.jsx("span",{className:"text-black  font-opensans font-semibold",children:Fe(null==D?void 0:D.amount)})]}),v.jsx("div",{children:v.jsxs("p",{className:"font-opensans text-sm",children:["I want to get this item for ",Fe(null==D?void 0:D.amount)]})})]}),v.jsx("div",{className:"mt-1 text-xs font-opensans text-gray-400",children:Te(null==D?void 0:D.createdAt)}),"countered"===(null==D?void 0:D.status)&&(null==D?void 0:D.counterAmount)&&v.jsxs("div",{className:"mt-3",children:[v.jsxs("div",{className:"bg-blue-50 text-blue-900 rounded-lg px-4 py-2 font-opensans max-w-xs",children:["Countered at ",Fe(D.counterAmount)," — waiting for buyer"]}),v.jsx("div",{className:"mt-1 text-xs font-opensans text-gray-400",children:Te(null==D?void 0:D.counteredAt)})]}),"accepted"===(null==D?void 0:D.status)&&v.jsxs("div",{className:"mt-3",children:[v.jsx("div",{className:"bg-green-50 text-green-900 rounded-lg px-4 py-2 font-opensans max-w-xs",children:"You accepted this offer. Buyer will be notified."}),v.jsx("div",{className:"mt-1 text-xs font-opensans text-gray-400",children:Te(null==D?void 0:D.acceptedAt)})]}),"declined"===(null==D?void 0:D.status)&&v.jsxs("div",{className:"mt-3",children:[v.jsx("div",{className:"bg-red-50 text-red-900 rounded-lg px-4 py-2 font-opensans max-w-xs",children:"You declined this offer."}),v.jsx("div",{className:"mt-1 text-xs font-opensans text-gray-400",children:Te(null==D?void 0:D.declinedAt)})]})]}):v.jsxs(v.Fragment,{children:[v.jsx("div",{className:"bg-gray-100 text-gray-800 rounded-lg px-4 py-2 font-opensans max-w-xs",children:null==ee?void 0:ee.question}),v.jsx("div",{className:"mt-1 text-xs font-opensans text-gray-400",children:Te(null==ee?void 0:ee.createdAt)})]})})]}),"closed"===(null==ee?void 0:ee.status)&&ee.vendorReply&&v.jsx("div",{className:"flex justify-end",children:v.jsxs("div",{children:[v.jsx("div",{className:"bg-customOrange text-white rounded-lg px-4 py-2 font-opensans max-w-xs",children:ee.vendorReply}),v.jsx("div",{className:"mt-1 text-xs text-gray-400 text-right font-opensans",children:Te(ee.repliedAt)})]})})]}),!W&&"open"===(null==ee?void 0:ee.status)&&v.jsx("div",{className:"border-t px-4 py-3",children:v.jsxs("div",{className:"relative",children:[v.jsx("input",{type:"text",className:"w-full border border-gray-300 rounded-full px-4 py-2 pr-16 text-base font-opensans focus:outline-none focus:ring-2 focus:ring-customOrange",placeholder:"Type your reply…",value:le,onChange:e=>ie(e.target.value),disabled:de}),v.jsx("button",{onClick:async()=>{if(le.trim()){ce(!0);try{const e=f(m,"inquiries",M);await I(e,{vendorReply:le.trim(),repliedAt:A(),status:"closed"}),T.success("Reply sent."),setTimeout((()=>q("/vchats")),500)}catch(e){T.error("Could not send reply. Try again.")}finally{ce(!1)}}else T.error("Please type a reply before sending.")},disabled:de||!le.trim(),className:"absolute right-2 top-1/2 transform -translate-y-1/2 bg-customOrange text-white rounded-full p-1.5 text-xl "+(de||!le.trim()?"opacity-50 cursor-not-allowed":"hover:bg-orange-600"),children:de?v.jsx(C,{height:20,width:20,strokeWidth:4,color:"#ffffff",secondaryColor:"transparent",visible:!0}):v.jsx($,{})})]})}),W&&Ae&&v.jsx(v.Fragment,{children:W&&v.jsx("div",{className:"border-t px-4 py-3",children:(()=>{const e=D&&Me&&!["accepted","declined"].includes(D.status)&&Number(Me.price||0)>Number(D.amount||0)+1,s=D&&!["accepted","declined"].includes(D.status);return K?v.jsxs("div",{className:"flex items-center gap-2",children:[v.jsx("input",{type:"number",inputMode:"numeric",placeholder:"Enter counter price",className:"flex-1 border border-gray-300 rounded-full px-4 py-2 text-base font-opensans focus:outline-none focus:ring-2 focus:ring-customOrange",value:je,onChange:e=>Ne(e.target.value),min:D?Number(D.amount||0)+1:void 0,max:Me?Math.max(D?Number(D.amount||0)+1:0,Number(Me.price||0)-1):void 0,disabled:!e}),v.jsx("button",{onClick:$e,disabled:!je||Number(je)<=0||!e,className:"px-4 py-4 rounded-full text-white font-opensans "+(!je||Number(je)<=0||!e?"bg-gray-300 cursor-not-allowed":"bg-customRichBrown hover:opacity-95"),children:v.jsx(O,{})}),v.jsx("button",{onClick:()=>{V(!1),Ne("")},className:"px-4 py-4 rounded-full border border-gray-300 font-opensans hover:bg-gray-50",children:v.jsx(R,{})})]}):v.jsxs("div",{className:"flex items-center gap-2",children:[v.jsx("button",{onClick:Pe,disabled:!s,className:"flex-1 border text-red-400 border-gray-300 rounded-full py-2 font-opensans "+(s?"hover:bg-gray-50":"opacity-50 cursor-not-allowed"),children:"Decline"}),v.jsx("button",{onClick:()=>V(!0),disabled:!e,className:"flex-1 rounded-full py-2 font-opensans "+(e?"bg-customRichBrown text-white hover:opacity-95":"bg-gray-300 text-white cursor-not-allowed"),children:"Counter"}),v.jsx("button",{onClick:Le,disabled:!s,className:"flex-1 bg-customOrange text-white rounded-full py-2 font-opensans "+(s?"hover:bg-orange-600":"opacity-50 cursor-not-allowed"),children:"Accept"})]})})()})}),W&&v.jsx(v.Fragment,{children:(()=>{const e=((null==D?void 0:D.status)||"pending").toLowerCase(),s=Ie[e]||Ie.pending;return v.jsxs("div",{className:"mt-2 flex flex-col items-center justify-center",children:[v.jsxs("span",{className:["inline-flex items-center gap-2 px-3 py-1 rounded-full text-[9px] font-semibold","ring-1",s.bg,s.text,s.ring,"shadow-[inset_0_0_0_1px_rgba(255,255,255,0.4)]"].join(" "),children:[v.jsx("span",{className:`w-1 h-1 rounded-full ${s.dot} ${"pending"===e?"animate-pulse":""}`}),v.jsx("span",{children:s.label}),"countered"===e&&(null==D?void 0:D.counterAmount)?v.jsxs("span",{className:"opacity-70",children:["· ",Fe(D.counterAmount)]}):null]}),v.jsxs("div",{className:"mt-1 text-[8px] text-gray-500 font-opensans",children:["pending"===e&&"Waiting for your action","countered"===e&&"Sent to buyer ","accepted"===e&&"Buyer will be notified","declined"===e&&"Offer closed","expired"===e&&"No longer valid"]})]})})()}),W?v.jsxs("div",{className:"text-center text-xs text-gray-500 py-2 px-3 font-opensans",children:["We take measures to prevent spam or unrealistic offers. Want to improve this experience?"," ",v.jsx("span",{className:"text-customOrange underline cursor-pointer",onClick:()=>q("/send-us-feedback"),children:"Send feedback"}),"."]}):"open"===(null==ee?void 0:ee.status)?v.jsx("div",{className:"text-center text-xs text-gray-500 py-2 font-opensans",children:"Chats are monitored in real-time."}):v.jsx("div",{className:"text-center text-xs text-gray-500 py-2 px-3 font-opensans",children:"This chat is closed. You’ve answered their question—now focus on making that sale!"}),Ce&&v.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center",onClick:()=>Oe(!1),children:v.jsxs("div",{className:"bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6",onClick:e=>e.stopPropagation(),children:[v.jsxs("div",{className:"flex items-center justify-between mb-4",children:[v.jsx("h2",{className:"font-opensans text-lg font-semibold",children:"Report Status"}),v.jsx(S,{className:"text-black text-xl cursor-pointer",onClick:()=>Oe(!1)})]}),v.jsx("p",{className:"font-opensans text-sm",children:"You’ve already reported this chat. Our team is reviewing it and will keep you updated. Thanks for bringing this to our attention."}),v.jsx("div",{className:"mt-6 flex justify-end",children:v.jsx("button",{className:"bg-customOrange text-white px-4 py-2 rounded-full",onClick:()=>Oe(!1),children:"OK"})})]})}),me&&v.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center",onClick:()=>pe(!1),children:v.jsxs("div",{className:"bg-white rounded-lg shadow-lg w-full  mx-4 p-4",onClick:e=>e.stopPropagation(),children:[v.jsxs("div",{className:"flex items-center justify-between mb-4",children:[v.jsxs("div",{className:"flex items-center space-x-2",children:[v.jsx("div",{className:"w-7 h-7 bg-rose-100 flex justify-center items-center rounded-full",children:v.jsx(k,{className:"text-customRichBrown"})}),v.jsx("h2",{className:"font-opensans text-lg font-semibold",children:"Report Chat"})]}),v.jsx(S,{className:"text-black text-xl cursor-pointer",onClick:()=>pe(!1)})]}),v.jsxs("div",{className:"space-y-3  mb-4",children:[["Harassment","Spam","Inappropriate language","Other"].map((e=>v.jsxs("div",{className:"flex items-center cursor-pointer",onClick:()=>{he(e),"Other"!==e&&be("")},children:[v.jsx("div",{className:"w-5 h-5 rounded-full border-2 flex justify-center items-center mr-3 "+(fe===e?"border-customOrange":"border-customOrange/60"),children:fe===e&&v.jsx("div",{className:"w-3 h-3 rounded-full bg-customOrange"})}),v.jsx("span",{className:"font-opensans",children:e})]},e))),"Other"===fe&&v.jsx("textarea",{rows:3,className:"border w-full rounded font-opensans p-2 text-base mt-2 resize-none overflow-hidden",placeholder:"Tell us what's wrong...",value:ge,onChange:e=>be(e.target.value)})]}),v.jsx("div",{className:"flex justify-end",children:v.jsx("button",{disabled:ve||!fe||"Other"===fe&&!ge.trim(),className:"bg-customOrange text-white px-10 py-2 rounded-full disabled:opacity-40",onClick:async()=>{ye(!0);try{const e=f(m,"inquiries",M);await I(e,{reported:!0,reportReason:"Other"===fe?ge.trim():fe,status:"open"===(null==ee?void 0:ee.status)?"closed":null==ee?void 0:ee.status,reportedAt:A()}),pe(!1),ke(!0)}catch(e){T.error("Could not submit report. Please retry.")}finally{ye(!1)}},children:ve?v.jsx(C,{height:18,width:18,strokeWidth:4,color:"#fff"}):"Send"})})]})}),we&&v.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center",onClick:()=>ke(!1),children:v.jsxs("div",{className:"bg-white rounded-lg shadow-lg w-full max-w-sm mx-4 p-6 text-center",onClick:e=>e.stopPropagation(),children:[v.jsx(k,{className:"mx-auto text-4xl text-customOrange mb-4"}),v.jsx("p",{className:"font-opensans text-sm mb-6",children:"Thanks for letting us know. We’re reviewing this chat and will keep you updated."})]})})]})]})}export{M as default};
