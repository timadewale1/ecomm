import{C as e}from"./index-cxFEw-_0.js";const t=/_key\s*==\s*['"](.*)['"]/;function n(e){if(!Array.isArray(e))throw new Error("Path is not an array");return e.reduce(((e,n,r)=>{const o=typeof n;if("number"===o)return`${e}[${n}]`;if("string"===o)return`${e}${0===r?"":"."}${n}`;if(function(e){return"string"==typeof e?t.test(e.trim()):"object"==typeof e&&"_key"in e}(n)&&n._key)return`${e}[_key=="${n._key}"]`;if(Array.isArray(n)){const[t,r]=n;return`${e}[${t}:${r}]`}throw new Error(`Unsupported path segment \`${JSON.stringify(n)}\``)}),"")}const r={"\f":"\\f","\n":"\\n","\r":"\\r","\t":"\\t","'":"\\'","\\":"\\\\"},o={"\\f":"\f","\\n":"\n","\\r":"\r","\\t":"\t","\\'":"'","\\\\":"\\"};function i(e){const t=[],n=/\['(.*?)'\]|\[(\d+)\]|\[\?\(@\._key=='(.*?)'\)\]/g;let r;for(;null!==(r=n.exec(e));)if(void 0===r[1])if(void 0===r[2])if(void 0===r[3]);else{const e=r[3].replace(/\\(\\')/g,(e=>o[e]));t.push({_key:e,_index:-1})}else t.push(parseInt(r[2],10));else{const e=r[1].replace(/\\(\\|f|n|r|t|')/g,(e=>o[e]));t.push(e)}return t}function s(e){return e.map((e=>{if("string"==typeof e||"number"==typeof e)return e;if(""!==e._key)return{_key:e._key};if(-1!==e._index)return e._index;throw new Error(`invalid segment:${JSON.stringify(e)}`)}))}function l(e,t){if(!(null==t?void 0:t.mappings))return;const n=function(e){return`$${e.map((e=>"string"==typeof e?`['${e.replace(/[\f\n\r\t'\\]/g,(e=>r[e]))}']`:"number"==typeof e?`[${e}]`:""!==e._key?`[?(@._key=='${e._key.replace(/['\\]/g,(e=>r[e]))}')]`:`[${e._index}]`)).join("")}`}(e.map((e=>{if("string"==typeof e||"number"==typeof e)return e;if(-1!==e._index)return e._index;throw new Error(`invalid segment:${JSON.stringify(e)}`)})));if(void 0!==t.mappings[n])return{mapping:t.mappings[n],matchedPath:n,pathSuffix:""};const o=Object.entries(t.mappings).filter((([e])=>n.startsWith(e))).sort((([e],[t])=>t.length-e.length));if(0==o.length)return;const[i,s]=o[0];return{mapping:s,matchedPath:i,pathSuffix:n.substring(i.length)}}function u(e){return"object"==typeof e&&null!==e}function a(e,t,n=[]){if(function(e){return null!==e&&Array.isArray(e)}(e))return e.map(((e,r)=>{if(u(e)){const o=e._key;if("string"==typeof o)return a(e,t,n.concat({_key:o,_index:r}))}return a(e,t,n.concat(r))}));if(u(e)){if("block"===e._type||"span"===e._type){const r={...e};return"block"===e._type?r.children=a(e.children,t,n.concat("children")):"span"===e._type&&(r.text=a(e.text,t,n.concat("text"))),r}return Object.fromEntries(Object.entries(e).map((([e,r])=>[e,a(r,t,n.concat(e))])))}return t(e,n)}function c(e,t,n){return a(e,((e,r)=>{if("string"!=typeof e)return e;const o=l(r,t);if(!o)return e;const{mapping:s,matchedPath:u}=o;if("value"!==s.type||"documentValue"!==s.source.type)return e;const a=t.documents[s.source.document],c=t.paths[s.source.path],p=i(u),f=i(c).concat(r.slice(p.length));return n({sourcePath:f,sourceDocument:a,resultPath:r,value:e})}))}const p=".",f=`drafts${p}`,d=`versions${p}`;function h(e){return e.startsWith(f)}function g(e){return e.startsWith(d)}function y(e){const{baseUrl:t,workspace:r="default",tool:o="default",id:i,type:l,path:u,projectId:a,dataset:c}=e;if(!t)throw new Error("baseUrl is required");if(!u)throw new Error("path is required");if(!i)throw new Error("id is required");if("/"!==t&&t.endsWith("/"))throw new Error("baseUrl must not end with a slash");const d="default"===r?void 0:r,y="default"===o?void 0:o,m=function(e){return g(e)?e.split(p).slice(2).join(p):h(e)?e.slice(f.length):e}(i),$=Array.isArray(u)?n(s(u)):u,_=new URLSearchParams({baseUrl:t,id:m,type:l,path:$});if(d&&_.set("workspace",d),y&&_.set("tool",y),a&&_.set("projectId",a),c&&_.set("dataset",c),function(e){return!h(e)&&!g(e)}(i))_.set("perspective","published");else if(g(i)){const e=function(e){if(!g(e))return;const[t,n,...r]=e.split(p);return n}(i);_.set("perspective",e)}const v=["/"===t?"":t];d&&v.push(d);const b=["mode=presentation",`id=${m}`,`type=${l}`,`path=${encodeURIComponent($)}`];return y&&b.push(`tool=${y}`),v.push("intent","edit",`${b.join(";")}?${_}`),v.join("/")}const m=({sourcePath:e,resultPath:t,value:n})=>{if(/^\d{4}-\d{2}-\d{2}/.test(r=n)&&Date.parse(r)||function(e){try{new URL(e,e.startsWith("/")?"https://acme.com":void 0)}catch{return!1}return!0}(n))return!1;var r;const o=e.at(-1);return!("slug"===e.at(-2)&&"current"===o||"string"==typeof o&&(o.startsWith("_")||o.endsWith("Id"))||e.some((e=>"meta"===e||"metadata"===e||"openGraph"===e||"seo"===e))||_(e)||_(t)||"string"==typeof o&&$.has(o))},$=new Set(["color","colour","currency","email","format","gid","hex","href","hsl","hsla","icon","id","index","key","language","layout","link","linkAction","locale","lqip","page","path","ref","rgb","rgba","route","secret","slug","status","tag","template","theme","type","textTheme","unit","url","username","variant","website"]);function _(e){return e.some((e=>"string"==typeof e&&null!==e.match(/type/i)))}function v(n,r,o){var i,s,l,u,a,p,f,d,h;const{filter:g,logger:$,enabled:_}=o;if(!_){const e="config.enabled must be true, don't call this function otherwise";throw null==(i=null==$?void 0:$.error)||i.call($,`[@sanity/client]: ${e}`,{result:n,resultSourceMap:r,config:o}),new TypeError(e)}if(!r)return null==(s=null==$?void 0:$.error)||s.call($,"[@sanity/client]: Missing Content Source Map from response body",{result:n,resultSourceMap:r,config:o}),n;if(!o.studioUrl){const e="config.studioUrl must be defined";throw null==(l=null==$?void 0:$.error)||l.call($,`[@sanity/client]: ${e}`,{result:n,resultSourceMap:r,config:o}),new TypeError(e)}const v={encoded:[],skipped:[]},k=c(n,r,(({sourcePath:t,sourceDocument:n,resultPath:r,value:i})=>{if(!1===("function"==typeof g?g({sourcePath:t,resultPath:r,filterDefault:m,sourceDocument:n,value:i}):m({sourcePath:t,resultPath:r,value:i})))return $&&v.skipped.push({path:b(t),value:`${i.slice(0,20)}${i.length>20?"...":""}`,length:i.length}),i;$&&v.encoded.push({path:b(t),value:`${i.slice(0,20)}${i.length>20?"...":""}`,length:i.length});const{baseUrl:s,workspace:l,tool:u}=function(e){let t="string"==typeof e?e:e.baseUrl;return"/"!==t&&(t=t.replace(/\/$/,"")),"string"==typeof e?{baseUrl:t}:{...e,baseUrl:t}}("function"==typeof o.studioUrl?o.studioUrl(n):o.studioUrl);if(!s)return i;const{_id:a,_type:c,_projectId:p,_dataset:f}=n;return e(i,{origin:"sanity.io",href:y({baseUrl:s,workspace:l,tool:u,id:a,type:c,path:t,...!o.omitCrossDatasetReferenceData&&{dataset:f,projectId:p}})},!1)}));if($){const e=v.skipped.length,n=v.encoded.length;if((e||n)&&(null==(u=(null==$?void 0:$.groupCollapsed)||$.log)||u("[@sanity/client]: Encoding source map into result"),null==(a=$.log)||a.call($,`[@sanity/client]: Paths encoded: ${v.encoded.length}, skipped: ${v.skipped.length}`)),v.encoded.length>0&&(null==(p=null==$?void 0:$.log)||p.call($,"[@sanity/client]: Table of encoded paths"),null==(f=(null==$?void 0:$.table)||$.log)||f(v.encoded)),v.skipped.length>0){const e=new Set;for(const{path:n}of v.skipped)e.add(n.replace(t,"0").replace(/\[\d+\]/g,"[]"));null==(d=null==$?void 0:$.log)||d.call($,"[@sanity/client]: List of skipped paths",[...e.values()])}(e||n)&&(null==(h=null==$?void 0:$.groupEnd)||h.call($))}return k}function b(e){return n(s(e))}var k=Object.freeze({__proto__:null,stegaEncodeSourceMap:v});export{c as encodeIntoResult,v as stegaEncodeSourceMap,k as stegaEncodeSourceMap$1};
