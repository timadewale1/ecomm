import{d as e,y as t,ab as a,ax as o}from"./index-CvIXhaMv.js";function n(e={}){return[e.id??e.productId??"",e.selectedColor??e.color??"",e.selectedSize??e.size??"",e.subProductId??"",e.variation??e.variant??""].join("|")}function r(e={},t={}){const a={},o={},r=[],c=new Set([...Object.keys(e||{}),...Object.keys(t||{})]);for(const s of c){const c=e[s]||{},d=t[s]||{},i=c.products||{},m=d.products||{},u={...i},l=new Map;for(const[e,t]of Object.entries(u))l.set(n(t),e);for(const[e,t]of Object.entries(m)){if(!t||!t.id&&!t.productId)continue;const a=n(t);if(l.has(a)){const e=l.get(a),n=u[e]||{},c=Number(n.quantity||0),d=Number(t.quantity||0),i=Math.max(1,c+d);u[e]={...n,quantity:i},r.push({vendorId:s,name:t.name||n.name||"Item",how:"quantity-summed"}),o[s]||(o[s]=[]),o[s].push(t.name||n.name||"Item (updated qty)")}else{let n=e;u[n]&&(n=`${e}__m${Math.random().toString(36).slice(2,8)}`,r.push({vendorId:s,name:t.name||"Item",how:"replaced-key"})),u[n]=t,l.set(a,n),o[s]||(o[s]=[]),o[s].push(t.name||"Item")}}const f=(Object.keys(u).length,c.vendorName?c:d);a[s]={...f||{},products:u}}return{merged:a,addedByVendor:o,conflicts:r}}async function c(n,c,s,d={}){const{localCart:i=JSON.parse(localStorage.getItem("cart")||"{}"),clearLocal:m=!0,onMerged:u}=d;try{const d=e(n,"carts",c),l=await t(d),f=l.exists()&&l.data().cart||{},{merged:p,addedByVendor:y,conflicts:h}=r(f,i);return await a(d,{cart:p}),"function"==typeof s&&s(o(p)),u&&u(p),m&&localStorage.removeItem("cart"),{mergedCart:p,addedByVendor:y,conflicts:h}}catch(l){throw l}}export{c as f,r as m};
